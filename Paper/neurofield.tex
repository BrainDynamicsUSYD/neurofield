\documentclass[preprint,review,10pt,authoryear,letterpaper]{elsarticle} 
\usepackage{todonotes} 
\usepackage{graphicx}
\usepackage[subrefformat=parens,labelformat=parens]{subfig}
\usepackage{amsmath,url}
\usepackage{amssymb}
\usepackage{booktabs} % Nicer tables
\usepackage{multirow} % Table cells spanning multiple rows
%\usepackage{lineno}
\usepackage[latin1]{inputenc}
\usepackage{tikz}
\usepackage[noperiod]{jabbrv}
\usepackage{listings}
\usepackage{matlab-prettifier}

% Handle missing figures
\usepackage{etoolbox}
\makeatletter
\patchcmd{\Gin@ii}
  {\begingroup}% <search>
  {\begingroup\renewcommand{\@latex@error}[2]{\includegraphics[width=0.5\columnwidth]{dummy}}}% <replace>
  {}% <success>
  {}% <failure>
\makeatother

\lstset{
basicstyle=\small\small\ttfamily,
frame=single,	        % adds a frame around the code
breaklines=true,		% sets automatic line breaking
breakatwhitespace=tru,	% sets if automatic breaks should only happen at whitespace
}
\newcommand{\code}[1]{ 
\begin{lstlisting}
#1
\end{lstlisting}
}


\usetikzlibrary{shapes,arrows}
\newcommand{\type}[1]{ {\small\small\tt #1} }
%\usepackage[noperiod]{jabbrv}

\biboptions{comma,sort&compress}

\biboptions{,comma,sort&compress}

\journal{Neuroscience Methods (TBD)}
  
\begin{document}

\begin{frontmatter}

\title{NeuroField: A Neural Field Theory simulation toolbox}


\author{P.K. Fung\corref{ffung}}
\ead{ffung@physics.usyd.edu.au}
\author{R.G. Abeysuriya\corref{}}
\author{X. Zhao\corref{}}
\author{P. M. Drysdale\corref{}}

\author{P.A. Robinson\corref{}}

\address{School of Physics, University of Sydney, New South Wales, Australia}
\cortext[ffung]{Corresponding author. Tel. +61 9036 7274}


\begin{abstract}

Neural field theories are powerful, computationally efficient approach to modeling large-scale brain phenomena. In particular, the versatile neural field theory of Robinson et. al. addresses questions on brain physiology and matches them with experimental observables including the EEG spectra, evoked response potentials, age-related changes to the physiology of the brain, seizures, and synaptic plasticity phenomena. This paper presents NeuroField as a user-friendly, extensible, portable, well-documented software package applicable to simulate a wide range of neural field phenomena, packaged with MATLAB and Python routines for higher-level analysis. NeuroField is %open-source and 
available for non-commercial use at \url{http://physics.usyd.edu.au/brain/neurofield}%under the GNU license 
. 
\end{abstract}

\begin{keyword}
%% keywords here, in the form: keyword \sep keyword
EEG \sep neurophysiology \sep methods \sep modeling
%% MSC codes here, in the form: \MSC code \sep code
%% or \MSC[2008] code \sep code (2000 is the default)

\end{keyword}

\end{frontmatter}

%\linenumbers

\section{Introduction}
\label{sec:introduction}

Neural field theory modeling is a powerful technique for constructing relatively simple, physiologically based models of the brain that are capable of predicting EEG and correlate well with experimental data \cite{Deco2008,Pinotsis2012}. In particular, the neural field theory of Robinson et. al. is a well established theory that addresses the EEG spectra, evoked response potentials, age-related changes to the physiology of the brain, seizures, and synaptic plasticity phenomena \citep{Robinson2005,Rowe2004413,PhysRevE.63.021903,PhysRevE.65.041924,Robinson:04aa,PhysRevE.68.021922,PhysRevE.70.011911,VanAlbada2010,Rennie2002,ker11,Breakspear2006}. In this neural field theory, we make a continuum approximation in which neural properties are averaged over spatial scales of an mm or so: sufficient to contain large numbers of neurons, but small enough to resolve fine structures in brain activities. Within this mean field context, rather than looking at individual neurons, we classify neural populations by the type of neuron (e.g. pyramidal excitatory neurons or inhibitory interneurons), and mean field quantities are label by their spatial position. In each modeling task, we specify the neural populations, stimulations, and synapto-dendritic connections between them (self-connection within a population is allowed), so that each neural population receives local dendritic voltage input and influences other populations via its action potential firing, measured via its instantaneous axonal action potential firing rate. Figure~\ref{fig:ct_schematic} is an example of such a ``population model," where we have two cortical populations and two thalamic populations, with intracortical, intrathalamic, and corticothalamic connections; details about this particular population model can be found in Sec.~\ref{sec:ct}.

\begin{figure}[ht]
\begin{center}
\includegraphics[width=0.50\columnwidth]{EIRS_clean}
\caption{Schematic illustration of the corticothalamic model, which contain excitatory and inhibitory cortical populations (\(e\) and \(i\), respectively), and reticular and relay thalamic populations (\(r\) and \(s\), respectively), where the relay population receives subthalamic stimulation. Arrows indicate excitatory connections, while roundheaded arrows indicate inhibitory connections. This population model is capable of capturing the alpha rhythm, age-related changes to the physiology of the brain, evoked response potentials, seizures, and many other phenomena, as elaborated in Sec.~\ref{sec:ct}.}
\label{fig:ct_schematic}
\end{center}
\end{figure}

The standard theory \citep{Robinson2005} is represented by three equations, which are schematically illustrated in Fig.~\ref{fig:eirs_cycle}.:
\begin{align}
	D_{ab}V_{ab}(\mathbf{r},t) &= \nu_{ab}\phi_{ab}(\mathbf{r},t),\\
			Q_a(\mathbf{r},t) &= S_a \big[\sum_b V_{ab}(\mathbf{r},t) \big],\\
	\mathcal{D}_{ab}\phi_{ab}(\mathbf{r},t) &= Q_b(\mathbf{r},t-\tau_{ab}).
\end{align}
whre the operators \(D_{ab}\), \(S_{a}\), and \(\mathcal{D}_{ab}\) capture synapto-dendritic smoothing, soma response, and axonal propagation of action potentials, respectively, given by

\begin{align}
	D_\alpha(t) &= \frac{1}{\alpha\beta}\frac{d^2}{dt^2} + \left( \frac{1}{\alpha} + \frac{1}{\beta}\right) \frac{d}{dt}+1,\\
	S(V_a) &= \frac{Q_{\textrm{max}}}{1+\exp[-(V_a - \theta)/\sigma']},\\
	\mathcal{D}_a(\mathbf{r},t) &= \frac{1}{\gamma_a^2}\frac{\partial^2}{\partial t^2} + \frac{2}{\gamma_a}\frac{\partial}{\partial t} + 1 - r_a^2\nabla^2,
\end{align}

In these equations, all dynamical quantities and operations are subscripted with population indices \(a\) (if it is associated with population \(a\)) or \(ab\) (if it is associated with the connection from \(b\) to \(a\)). The mathematical symbol \(\phi\) represents the axonal firing rate, \(\nu\) represents local somato-dendritic coupling strength, \(V_{ab}\) denotes the connection \(ab\)'s contribution to the soma voltage potential, which is summed via \(\sum_b V_{ab}\) to give the population soma voltage potential \(V_a\); \(Q\) is the population firing rate, which feeds into the axonal firing rate with a time delay \(\tau\). All neural quantities carry spatial and temporal dependencies. The operator parameters \(\alpha\) and \(\beta\) are the rise and decay rates of dendritic response, \(Q_\textrm{max}\) is the maximum firing rate, \(\theta\) is the mean firing threshold, \(\sigma'\) is the population standard deviation of the soma voltage relative to threshold, \(\gamma\) is the temporal damping coefficient, and \(r\) is the spatial effective range of axonal propagation. This can be schematically summarized in Fig.~\ref{fig:eirs_cycle}.

\begin{figure}[ht]
\begin{center}
\includegraphics[width=0.40\columnwidth]{EIRS_cycle}
\caption{Schematic overview of the key dynamic quantities \(V_a\), \(Q_a\) \(\phi_{ab}\) in the neural field model, as governed by Eqs~(1)--(3).}
\label{fig:eirs_cycle}
\end{center}
\end{figure}

Of course, one of the major strengths of the neural field theory of \citet{Robinson2005} is its versatility: by choosing the appropriate neural population model, we may model cortical phenomena ()\todo{refs}, the corticothalamic system ()\todo{refs}, or even hemispheric interactions ()\todo{refs}. Moreover, we may replace the operators above with more sophisticated ones, so as to model additional phenomena. For example, by replacing the constant synapto-dendritic coupling strength \(\nu\) with a dynamic one, we may model synaptic plasticity (see Sec.~\ref{sec:cadp}). Or, by replacing the sigmoidal soma firing response with differential equations, we can capture bursting firing rates (see Sec.~\ref{sec:burst}).

This versatility and extensibility of the theory presents a challenge in the implementation of the numerical solver. First, we need a program that takes an arbitrary number of neural populations, with possibly different population types and parameters for each population, and arbitrary connections between the populations, where again each connection may be of different types and is described by different parameter values. Several factors contribute to making the numerical integration of equations difficult: propagation delays between neural populations result in delay-differential equations that require special handling of temporal history; propagation of action potentials according to a damped wave equation adds two spatial dimensions to the system; periodic boundary conditions must be correctly handled during the integration. The popularity and extensibility of the theory means that the program will involve many developers, who extend and reuse previous code independently; coding level structure needs to be in place to ensure proper collaborative effort and minimizing the chance of error.

We have developed NeuroField as a software package that solves the neural field equations for arbitrary neural population models that is user-friendly and easily extensible. Written in C++, this code has been tested on a range of Linux distributions, Microsoft Windows, and Mac OS X. Front-ends written in MATLAB and Python are also provided for analysis and visualization. In this paper, we present the software as a solution to quickly testing and analyzing neural field models. This paper is structured as follows: in Sec.~\ref{sec:method}, we present the usage of NeuroField, including the MATLAB and Python interfaces, as well as the numerical algorithm of NeuroField; in Sec.~\ref{sec:results}, we present example usages of NeuroField in published neural field theory as a showcase of the capabilities of NeuroField. Separate manuals that provide documentations to all user options, extension procedures and coding algorithms are bundled with the NeuroField package.

\section{Method}
\label{sec:method}

\begin{figure}[h!t]
\begin{center}
\includegraphics[scale=.8]{flow.pdf}
\caption{Flow diagram illustrating typical NeuroField usage workflow, which can be categorized into three broad phrases: launching, simulation, and postprocessing. The core is the simulation phase, where NeuroField reads the configuration file (or config file for short), and generates the output file, which stores the simulation results. In the postprocessing phase, the simulation results are further analyzed and useful data, plots, figures may be generated. MATLAB and Python routines are provided to aid postprocessing. Similarly, MATLAB and Python wrapper scripts are provided to aid the creating and running of config files. Since both the config file and output file are human readable, they may be processed manually, and the use of any MATLAB and Python scripts are optional. Section~\ref{sec:neurofield} elaborates on the simulation phase, while Sec.~\ref{sec:interface} elaborates on the launching and postprocessing phases. In Sec.~\ref{sec:results} we present illustrative examples of NeuroField simulation results applied onto recent research.}
\label{fig:workflow}
\end{center}
\end{figure}

We present NeuroField, a C++ program bundled with MATLAB and Python scripts as a flexible numerical package specialized in solving Eqs~(1)--(6). The program reads a human readable configuration file (abbreviated as the config file), which specifies all the simulation information, including an arbitrary population model, (i.e., the number of populations and the connections between them,) and the type and parameter values of each population and connection. Figure~\ref{fig:config_text} presents an example config file, to be elaborated in Sec.~\ref{sec:interface}. Given the config file, NeuroField creates a human readable output file, which stores the time series of the neural quantities as requested by the user. Optional MATLAB and Python scripts are packaged with NeuroField to aid the launching and output analysis of the simulation. Figure~\ref{fig:workflow} is a flow diagram summarizing the workflow of NeuroField usage. Ample documentation of all usage options, config file options and scripting interfaces are bundled with the software package, so that we will not exhaust these information in this paper. Below, we first explain the structure and algorithm of the program in Sec.~\ref{sec:neurofield}, and in Sec.~\ref{sec:interface}, we provide a brief overview of the interfaces of NeuroField.

\subsection{Code structure and simulation algorithms}
\label{sec:neurofield}

The NeuroField program uses standard C++ features including object-ori\-ented programming, templates programming, and the C++ standard library, and has been tested on a range of Linux distributions, Microsoft Windows, and Mac OS~X.
% history: Peter Drysdale wrote the first version, Felix Fung rewrote the entire code, but all the algorithm is still Peter Drysdale's.

To solve Eqs~(1)--(6), NeuroField creates objects to handle the time integration of neural dynamical quantities. Each neural population is associated with a firing response to handle the population firing governed by Eqs~(2) and (5), while each connection between two populations is associated with the axonal propagation of the instantaneous firing rate of the presynaptic neural population (to handle Eqs~(3) and (6)), and the synaptic and dendritic coupling of the postsynaptic population (to handle Eqs~(1) and (4)). We may rearrange Eqs~(1)--(3) into this form to illustrate the division of the system of partial differential equations:
\begin{align}
	P_{ab} &= \nu_{ab}\phi_{ab}, & \text{Synaptic coupling}\\
	D_{ab}V_{ab} &= P_{ab}, & \text{Dendritic response}\\
	Q_a &= S_a \big[\sum_b V_{ab} \big], & \text{Firing response}\\
	\mathcal{D}_{ab}\phi_{ab} &= Q_b,&  \text{Axonal propagation}
\end{align}
which can be schematically summarized in Fig.~\ref{fig:components}.

\begin{figure}
\begin{center}
\tikzstyle{pop_style} = [rectangle, draw, text width=6em, text centered, minimum height=4em]
\tikzstyle{couple_style} = [rectangle, draw, text width=6em, text centered, minimum height=4em,fill=gray!30]
\tikzstyle{line} = [draw, -latex']    
\begin{tikzpicture}[node distance = 2.7cm, auto]
	\node[pop_style] (qresponse) {Firing response\\$\sum_bV_{ab} \rightarrow Q_a$};
    %\node[pop_style,right of=qresponse] (pop) {\texttt{Population}\\$Q_b$};
    \node[couple_style,right of=qresponse] (propag) {Axonal propagation\\ $Q_b \rightarrow \phi_{ab}$};
    \node[couple_style,right of=propag] (couple) {Synaptic coupling\\$\phi_{ab} \rightarrow \nu_{ab}\phi_{ab}$};
    \node[couple_style,right of=couple] (dendrite) {Dendritic response\\$\nu_{ab}\phi_{ab}\rightarrow V_{ab}$};
    \draw[line] (qresponse) -- (propag);
    \draw[line] (propag) -- (couple);
    \draw[line] (couple) -- (dendrite);
\end{tikzpicture}
\caption{Flow diagram illustrating the NeuroField algorithm, where each equation of \citet{Robinson2005} is handled by a C++ object. Here, a firing response (white fill) is associated with each neural population, while each gray-filled objects are associated with each connection between two populations. Compare with Fig.~\ref{fig:eirs_cycle}. Importantly, each object may be extended or replaced via C++ inheritance, so that new object types provide extension to the standard \citet{Robinson2005} theory.}
\label{fig:components}
\end{center}
\end{figure}

In these equations, we first introduce an auxiliary variable \(P\) into the synaptic coupling object to handle synaptic input weighted by the local synaptodendritic coupling strength. One advantage of this arrangement is that we may use the object-oriented feature of C++ to introduce synaptic plasticity into the synaptic coupling object. While in the standard theory of \citet{Robinson2005} the synaptic coupling strength \(\nu_{ab}\) is constant, \citet{fung13,fung14} extended the synaptic coupling class via inheritance to implement synaptic plasticity with a 4\textsuperscript{th} order Runge-Kutta solver, where the results will be elaborated in Sec.~\ref{sec:cadp}. Another possibility is to introduce nonlocal coupling by generalizing the synaptodendritic coupling strength \(\nu_{ab}\) from a vector to a tensor \citep{fung14}:
\begin{equation}
	\nu_{ab}(\mathbf{r}) \rightarrow \nu_{ab}(\mathbf{r}',\mathbf{r}),
\end{equation}
where \(\mathbf{r}'\) is the spatial position of the incoming stimulus, so that we have instead of Eq.~(7),
\begin{equation}
	P_{ab} = \int \nu_{ab}(\mathbf{r}',\mathbf{r}) \phi_{ab}(\mathbf{r}') \mathrm{d^2\mathbf{r}'},
\end{equation}

Each dendrite object takes in the variable \(P_{ab}\) from the corresponding synaptic coupling object, and uses explicit integration to calculate the voltage contribution \(V_{ab}\) from neural population \(b\) to population \(a\).

Each neural population is associated with a firing response object, which performs synaptic integration of dendritic voltages by summing over all dendritic voltages. Then, the sigmoidal firing rate is calculated via Eq.~(5). Alternatively, a linear approximation of Eq.~(5) may be used, which is useful in comparison with the sigmoidal computation to explore nonlinear effects, to be elaborated in Sec.~\ref{sec:ct}. Another possibility is to introduce burst firing patterns via elaborated system of differential equations to model the ion channel dynamics, to be elaborated in Sec.~\ref{sec:burst}.

The axonal propagation between two neural populations is handled by an axonal propagation object, governed by the damped wave equation~(6), with a propagation time delay \(\tau\). Much of the complexity of NeuroField lies in the solving of this delay-partial differential equation with spatial dependence. Correct, efficient implementation of this step tends to be the biggest hurdle to implementing a neural field model. NeuroField solves by storing the neural firing rate histories and uses explicit finite differences integration with a nine-point stencil. By default, Euclidean geometry with toroidal topology is used. However, non-Euclidean geometry or alternative boundary conditions may be implemented, so that simulation may be performed on surfaces such those found in structural MRI in the future.

In the cases when the damping coefficient is large, as in the cases of cortical inhibitory neurons or thalamic neurons, the damped wave equation may be approximated by the identity equation,
\begin{align}
	\mathcal{D}_a(\mathbf{r},t) &= 1,\\
	\phi(\mathbf{r},t) &= Q(\mathbf{r},t-\tau),
\end{align}
constituting the simplest numerical algorithm for the coding implementation.

Another simplification comes in when we perform a spatially homogeneous simulation, so that the Laplacian term in Eq.~(6) vanishes to give a damped oscillator, and a explicit integration implementation is used to reduce computation in such cases.

Thus, the coding structure of NeuroField is designed with flexibility and extensibility of the neural field theory in mind, where each coding component allows easy extension. In addition, a generic 4\textsuperscript{th} order Runge-Kutta solver is implemented for all NeuroField objects (used in, for example, synaptic plasticity extension, see Sec.~\ref{sec:cadp}), and a generic 9-point stencil for numerical integration involving spatial dependency is available (used in, for example, axonal wave propagation). A developer's guideline is bundled with the NeuroField package, which provide a complete document on the algorithm and code structure of NeuroField, as well as guideline for code development. Thus, extension of the neural field theoretic equations is very simple in NeuroField, where the development time may be in the order of only a few hours.

Of course, normal usage of NeuroField does not involve coding extension, and Fig.~\ref{fig:workflow}, Table~\ref{tab:task} and Sec.~\ref{sec:interface} elaborates on NeuroField usage and interface.

\subsection{User interfaces}
\label{sec:interface}

As shown in Fig.~\ref{fig:workflow}, the core NeuroField C++ program takes in a plain text configuration file (abbreviated as the config file), where the user specifies all the simulation information, and write the simulation result into a output file. A separate user manual, that is bundled with the software package, exhaustively documents all the options for the user interface, so that it will not be repeated here. Rather, we provide a brief overview of the interface below, and Sec.~\ref{sec:results} presents illustrative results.

Table~\ref{tab:task} tabulates typical NeuroField usage tasks, and the corresponding work required. Most tasks involve only editing the config file, and then postprocessing the simulations results, so that only the launching and postprocessing phase in Fig.~\ref{fig:workflow} requires attention. Even so, ample helper scripts exist to aid both the launching and postprocessing phase.

\begin{table}
	\begin{tabular}{ p{4.2cm} p{4.5cm} l }
	\hline
	Task & Action & File \\
	\hline
	Perform simulation & Run NeuroField manually, or via helper scripts & --- \\
	%Visualize/analyze results & --- & MATLAB and Python helper scripts \\
	Parameter exploration & Change parameter value & In config file \\
	Use alternative object type & Change object type & In config file \\
	Use alternative population model & Change connection matrix and objects & In config file \\
	Create new object type & Write new C++ class & In source code \\
	\hline
\end{tabular}
\caption{NeuroField tasks requirements, in roughly ascending order of difficulty, so that a task lower in the table often involve also doing the tasks above the entry. Most simulations require only editing of the config file; only the creation of new object types require code writing. Even for the latter, ample documentation, guidelines and working examples minimizes the coding workload. See also Fig.~\ref{fig:workflow} for NeuroField usage workflow and interface.}
\label{tab:task}
\end{table}

\subsubsection{Input}

Figure~\ref{fig:config_text} is an example config file for the neural field model to be discussed in Sec.~\ref{sec:wave}. The config file starts with a descriptive comment. Then, simulation parameters including simulation duration and time step size, and the number of spatial nodes are specified. This is followed by the specification of a square connection matrix, where a non-zero entry indicate a connection between two populations, so that each connection consists of a axonal propagation from the presynaptic neural population, and a dendritic and firing response from the postsynaptic population. Then, each neural field object, which include firing response ({\tt Firing}), dendritic response ({\tt Dendrite}), axonal propagation ({\tt Propag}) and synaptic coupling ({\tt Couple}), is specified via a {\tt identifier: type - } syntax, followed by the designated parameter values, which follow a {\tt parameter: value} syntax. In the example of Fig.~\ref{fig:config_text}, the axonal propagation of the excitatory-excitatory self-coupling ({\tt Propag 1}) is a ``wave" type propagation, that has a characteristic spatial range of 0.2 m and a damping coefficient of 30 s\textsuperscript{-1}.

\begin{figure}[!htbp]
\begin{center}
\begin{lstlisting}
Example configuration file for one-population neural field model
Time: 0.15 Deltat: 0.0001
Nodes: 900

    Connection matrix:
From:  1  2 
To 1:  1  2  
To 2:  0  0  


Population 1: Excitatory
Length: 0.5
Q: 10=
Firing: Sigmoid - Theta: 0.01292 Sigma: 0.0038 Qmax: 340
 Dendrite 1: alpha: 83 beta: 769
 Dendrite 2: alpha: 83 beta: 769

Population 2: Stimulation
Length: 0.5
 Stimulus: Pulse - Onset: 0 Node: 465 Amplitude: 1 Width: 1e-3 

Propag 1: Wave - Tau: 0 Range: 0.2 gamma: 30
Propag 2: Map - 

Couple 1:  Map - nu: 0
Couple 2:  Map - nu: 1e-4

Output: Node: All Start: 0 
Population: 1
Dendrite:  
Propag: 1
Couple:   
\end{lstlisting}
\caption{Example config file, for a one-population model receiving a pulse stimulus. Details and result of this system can be found in Sec.~\ref{sec:wave}.}
\label{fig:config_text}
\end{center}
\end{figure}

\begin{figure}[th]
\begin{center}
\begin{lstlisting}
    Time  |             Pop.1.V  |        Dendrite.1.V  |
          |                   1  |                   1  |
5.00e-03  | -1.020386100923e-03  |  2.589927678839e-02  |
1.00e-02  | -1.020386100890e-03  |  2.589927678842e-02  |
\end{lstlisting}
\caption{Example output file from NeuroField, where the time series of two neural dynamic quantities are outputted in columns. The first line provides the column heading, while the second line provides the spatial node index. Each subsequent line is outputted at a simulation time interval as the user dictated in the config file.}
\label{fig:output_text}
\end{center}
\end{figure}

\subsubsection{Output}

The outputting of simulation results are specified in the end of the config file. In Fig.~\ref{fig:config_text}, the excitatory population and the excitatory-excitatory axonal propagation is specified to be outputted, so that these two objects will output the time series of their neural dynamical quantities, which in this case will be population soma voltage and axonal firing rate, respectively. To ensure numerical stability, the equations need to be integrated with a very small time step (e.g., $1\times10^{-4}$\,s$=10000$\,Hz). This is much smaller than typically required for analysis; EEG is typically sampled at just 500~Hz or less. To reduce output file size and avoid unnecessarily long postprocessing computation, an output sampling interval can be specified, downsampling the output from NeuroField.

Figure~\ref{fig:output_text} shows an example output file; given it is human readable, standard tools may be used to analyze these data, in addition to the provided MATLAB and Python scripts. In Sec.~\ref{sec:postprocess-manual}, we explain that users can manually edit the human-readable interfaces to use NeuroField, and in Sec.~\ref{sec:postprocess-matlab}, we provide an overview on the MATLAB helper scripts that is bundled with NeuroField as additional interface.

\subsubsection{Manual read/write}
\label{sec:postprocess-manual}

Given that both the config file and output file are human readable (see Fig.~\ref{fig:config_text} and Fig.~\ref{fig:output_text}), manual usage of NeuroField without any helper scripts is possible, by writing the config file and reading the output file. This is particularly true as ample documentation and working example config files exist. Indeed, one convenient way of starting a simulation involves editing an existing config file until it matches the intended simulation environment, and running NeuroField. Since the output file is plain-text, it is very easy to use standard tools to perform postprocessing analysis on the simulation results. For example, a simple PERL script that calls gnuplot exists for simple time series plotting.

\subsubsection{MATLAB helper scripts}
\label{sec:postprocess-matlab}

In addition to manually editing the plain-text files, NeuroField is packaged with MATLAB helper scripts that assists with both the launching of NeuroField and postprocessing of simulation results.

The usage of these MATLAB scripts involves first reading the simulated results from the NeuroField output file into an ``NF" MATLAB object, via an {\tt nf\_read()} function, and then using the {\tt nf\_extract()} function to extract neural dynamic quantities. A number of functions are provided for visualization, including plotting routines and animation routines, and for the calculation of power spectra. In Sec.~\ref{sec:results}, we provide numerous examples of NeuroField simulations results, where the generation of these figures rely heavily on these helper scripts.

\todo[inline]{More from Romesh}

\begin{figure}[th]
\begin{center}
\begin{lstlisting}[style=Matlab-editor]
nf_object = nf_run('neurofield.conf')
time = nf.time;
V = nf_extract( nf, 'Pop.1.V' );
plot(time,V);
grid = nf_grid(nf,'Pop.1.V');
surf(grid(:,:,1));
\end{lstlisting}
\caption{Example usage of MATLAB helper scripts. The {\tt nf\_run()} function is used to execute a NeuroField configuration file and read the data into a MATLAB struct.  A plot of the time series is generated using the {\tt nf\_extract()} function. A surface plot showing spatial variations in potential is generated using the {\tt nf\_grid()} function.  Other functions including animation and spectral plots are also available.}
\label{fig:matlab_eg}
\end{center}
\end{figure}

%There are a number of common ways to analyze the output from neural field models. First, plots of the time series are useful for directly viewing neural oscillations, evoked responses, seizures, monitoring plasticiity, and verifying stability. Second, calculation of the power spectrum, which is often compared to experimental EEG. This can also involve detection of multiple spatial modes of activity and incorporation of volume conduction, to account for effects introduced by electrodes in real-world recordings. Finally, spatial patterns of activity and propagation of waves of activity can be visualized on a surface plot. All of these basic analyses are included as MATLAB programs in the NeuroField toolbox. 
%
%The nf\_extract() function makes it easy to select data for plotting from a NeuroField object. nf\_movie can plot an animation of the output
%
%NeuroField is packaged with several helper scripts written in MATLAB to assist with running, analyzing and visualizing models. 
%
%nf\_read() allows users to parse the output file from NeuroField into a MATLAB struct object.
%nf\_grid reshapes the output for handling matrices. 
%
%nf\_eirs() demonstrates writing a configuration file, running it with nf\_run(), and then reading it with nf\_read(). This demonstrates a complete MATLAB-based toolchain for using NeuroField.
%

\section{Result Demonstrations}
\label{sec:results}

In this section, we present examples of NeuroField simulation results applied to recent research as a showcase of the capabilities of NeuroField. All plots and figures are simulation results of NeuroField, where the plots are generated by the helper scripts explained in Sec.~\ref{sec:postprocess-matlab}.

\subsection{Single excitatory population model}
\label{sec:wave}

\begin{figure}[t]
\begin{center}
\includegraphics[width=0.50\columnwidth]{one-pop}
\caption{Schematic diagram of a single excitatory population model, which feeds back to itself and receive an external stimulus. This constitutes the simplest neural field model that conforms to Eqs~(1)--(6).}
\label{fig:single}
\end{center}
\end{figure}

We first present the simplest neural field model possible, consisting of a single neural population that recieves an external stimulus. All neural dynamics are as Eqs~(1)--(6), so that this model conforms to the standard \citet{Robinson2005} theory. The configuration file is shown in Fig.~\ref{fig:config_text}, and no extension of NeuroField coding is required. All parameters are taken from \citet{Robinson:04aa}, with the exception of the axonal propagation parameters, which are tuned to emphasize wave propagation properties for illustrative purposes.

Figure~\ref{fig:wave_comparison} presents the neural dynamics of the system in two snapshots, as generated by the MATLAB helper scripts presented in Sec.~\ref{sec:postprocess-matlab}. Here, the \(x\) and \(y\) coordinates are spatial coordinates, and the vertical axis plots the axonal firing rate as a measure of neural activity. Figure~\ref{fig:wave_comparison}~(a) show that the neural dynamics of the population is in a steady state and has achieved spatial homogeneity, while receiving a stimulus in the middle. Figure~\ref{fig:wave_comparison}~(b) shows the neural dynamics at a later time instance, and we see that the stimulus spread according to damped wave propagation. In addition to generating plots, one MATLAB helper script (see Sec.~\ref{sec:postprocess-matlab}) also generates movies, which would aid the analysis of wave propagation in this example.

\todo[inline]{Romesh please check transient vs stable state and stimulation onset (and why are we plotting V and phi?)}

\begin{figure}[t]
\begin{center}
\includegraphics[width=.9\textwidth]{wave_comparison}
\caption{Two plots on the neural activity of the one-population model first introduced in Fig.~\ref{fig:one-pop}. The \(x\) and \(y\) coordinates are spatial coordinates, while the vertical axis is the axonal firing rate, which serves as a measure of neural activity. (a) Neural activity is in a steady state, where the firing rate is spatially homogeneous, while receiving a stimulus in the middle. (b) Neural activity propagates radially outwards, as governed by the damped wave equation~(6).}
\label{fig:wave_comparison}
\end{center}
\end{figure}

\todo[inline]{Put labels (a) and (b) into figure.}

\subsection{Single population with synaptic plasticity}
\label{sec:cadp}

The single-excitatory population model of Sec.~\ref{sec:wave} may be extended to model synaptic plasticity. \citet{fung13} and \citet{fung14} extended the standard theory of \citet{Robinson2005} by introducing time dependence on the synapto-dendritic coupling strength \(\nu\) in Eq.~(7), to model the experimental results found in transcranial magnetic stimulation (TMS). The coding implementation is done by inheriting the synaptic coupling class, and using the generic 4\textsuperscript{th} order Runge-Kutta solver provided in NeuroField.

Figure~\ref{fig:cadp} shows a schematic diagram for the synaptic plasticity theory of \citet{fung13} and \citet{fung14}, illustrating how neural activity leads to intraneuronal calcium influx, which signals synaptic plasticity expression, which in turn is modulated by metaplasticity on a longer timescale. Figure~\ref{fig:cadp-window} presents a comparison between experimental results and NeuroField simulation results in paired associative stimulation (PAS), a variation of TMS experiment. The reproduction of experimental result via the introduction of mean field calcium level and synaptic plasticity into neural field theory demonstrates the flexibility and extensibility of NeuroField.

\begin{figure}[t]
\begin{center}
\includegraphics[width=.7\textwidth]{bcm-schematic}
\caption{Schematic diagram illustrating the plasticity theory used in \citet{fung13} and \citet{fung14}. Within the context of neural field theory, we introduce mean field intraneuronal calcium and non-static synaptic coupling strength, so that neural activity leads to intraneuronal calcium influx, which signals synaptic plasticity, which in turn is modulated by metaplasticity. Expression of synaptic plasticity feeds back into neural activity, introducing a loop. This is implemented into NeuroField via C++ inheritance on the synaptic coupling object, and using the generic 4\textsuperscript{th} order Runge-Kutta solver provided. Figure reproduced from \citet{fung14}.}
\label{fig:cadp}
\end{center}
\end{figure}

\begin{figure}[t]
\begin{center}
\includegraphics[width=.8\textwidth]{window}
\caption{Experimental and simulation results of paired associative stimulation (PAS), where transcranial magnetic stimulation and peripheral electric stimulation is applied with an inter-stimulus interval (ISI) in between. Depending on the size and ordering of the ISI, different size and direction of synaptic plasticity may be induced. Dots and error bars: mean and standard deviation from experiments; line: NeuroField simulation result. Figure reproduced from \citet{fung13}.}
\label{fig:cadp-window}
\end{center}
\end{figure}

\subsection{Corticothalamic model}
\label{sec:ct}

NeuroField has been extensively tested with a recent neural field corticothalamic model of the brain \citep{Robinson2005,Rowe2004413,PhysRevE.63.021903,PhysRevE.65.041924,Robinson:04aa} that we have previously used to investigate the alpha rhythm \citep{PhysRevE.68.021922,PhysRevE.70.011911}, age-related changes to the physiology of the brain \citep{VanAlbada2010}, evoked response potentials \citep{Rennie2002,ker11}, seizures \citep{Breakspear2006}, and many other phenomena. 

The structure of the model is shown in Fig.~\ref{fig:ct_schematic}. 
Our model predictions are often tested against EEG measures, with $\phi_e(\mathbf{r},t)$ (as marked in Fig.~\ref{fig:ct_schematic}) being associated with the measured EEG signal at position $\mathbf{r}$. 
Much of our work is in the linear regime and utilizes analytic results for small perturbations to steady states. Steady states can be obtained by setting the differential operators \eqref{eq:dendrite} and \eqref{eq:wave} to unity, and solving for the the steady state firing rate $\phi_e^{(0)}$ \cite{Robinson:04aa}. 
However, some phenomena are strongly nonlinear, and these must be solved by numerical integration. We have used NeuroField to model results relating to seizures \citep{Roberts2008}, visually evoked potentials \citep{Roberts2012a}, and sleep spindles \citep{Abeysuriya2013,Abeysuriya2013a}.  

The EEG time series is directly produced by NeuroField. 
The power spectrum can be obtained by FFT, but correct normalization and calculation of the power spectrum including multiple spatial modes can be challenging to implement. With periodic boundary conditions, the EEG power spectrum is given by the summation
\begin{align}
\label{eqn:power_sum}
P(\omega) &= \sum_{m = -\infty}^{\infty}\sum_{n = -\infty}^{\infty} \Delta k_x \Delta k_y |\phi_e(\mathbf{k},\omega)|^2|F(k)\\
k^2 &=  \left( \frac{2\pi m}{L_x} \right)^2 + \left( \frac{2\pi n}{L_y}\right)^2
\end{align}
where the size of the two-dimensional rectangular cortex is $L_x \times L_y$. In practice, modes with large $\mathbf{k}$ are strongly damped, so only a small number of spatial modes need to be included \citep{OConnor2002}. Volume conduction by the cerebrospinal fluid, skull and scalp serves as a low-pass spatial filter whose $k$ dependence is well fitted by the form \citep{PhysRevE.63.021903,Rowe2004413,alb06a,VanAlbada2010}
\begin{align}
F(k) &= e^{-k^2/k_0^2},
\end{align}
with a low-pass cutoff $k_0 \approx 10$\,m$^{-1}$ based on the spherical harmonic head transfer function developed by \cite{Srinivasan1998}.

Both summation over spatial modes and volume conduction filtering are implemented in MATLAB helper scripts in the NeuroField toolbox. Figure.~\ref{fig:spindle_comparison} shows a three-way comparison between the linear analytic prediction, the nonlinear spectrum generated by NeuroField, and the linear spectrum generated by NeuroField. The model parameters are drawn from \citet{Abeysuriya2013} and correspond to sleep spindles. The linear NeuroField spectrum is computed by changing the population \texttt{qresponse} to a linear function, which can simply be selected in the configuration file. There is an excellent match between the linear analytic spectrum and the linear NeuroField spectrum, verifying our implementation of the numerical integrator and power spectrum helper scripts. The nonlinear spectrum shows an additional harmonic peak not present in the linear model. 

\begin{figure}[!htbp]
\begin{center}
\includegraphics[width=0.85\columnwidth]{corticothalamic_comparison}
\caption{EEG power spectrum for sleep spindles, for parameters in \citet{Abeysuriya2013}. The linear analytic spectrum and linear NeuroField spectrum are an excellent match. The nonlinear NeuroField spectrum shows additional features that arise due to nonlinear effects in the model, in this case corresponding to a nonlinear sleep spindle harmonic \citep{Abeysuriya2013a}.}
\label{fig:spindle_comparison}
\end{center}
\end{figure}

\subsection{Seizures}
\label{sec:seizures}
\todo[inline]{Content from Xuelong}

\subsection{Corticothalamic model with bursting dynamics}
\label{sec:burst}
\todo[inline]{Content from Xuelong}


\subsection{Demonstration of applications to other models?}
Could demonstrate using NeuroField for Wilson-Cowan or a Jansen-Rit neural mass model, showing that the same framework can be used to quickly reproduce previous work with older or less accurate models, and then extend to more realistic neural field models. 

\section{Discussion}
\label{sec:discussion}

We have developed NeuroField to provide an extensible, reliable framework for integrating nonlinear delay differential equations including spatial propagation. NeuroField is aimed for use by researchers who have constructed neural field models of the brain that require numerical integration. In this section, we review some usage and performance considerations.

Most notably, the signals from populations can be associated with local field potentials (LFP) or EEG depending, and these predictions can be directly compared against experimental data. The soma potential or firing rate of the neural populations can be compared to individual neuron data. Changes to synaptic strength can be monitored when simulating neural plasticity. When simulating spatially extended populations, spatial correlations and patterns of activity can also be analyzed. 

\subsection{White noise stimulus}
\begin{itemize}
	\item White noise requires stocastic DE integrator, effectively Euler (FELIX)
\end{itemize}

Many neural simulations drive the system using spatially uncorrelated white noise, which is typically denoted in our model as $\phi_n(\mathbf{r},t)$. This noise signal can be efficiently generated by sampling from a normal distribution $\mathcal{N}(\mu,\sigma^2)$ at each grid point and time step. However, the power spectrum of this noise signal $\phi_n(\mathbf{k},\omega)$ depends on $\sigma$, the time step $\Delta t$, and grid resolution $\Delta x$ and $\Delta y$. Intuitively, the standard deviation $\sigma$ represents the sum of all of the frequency components $\phi_n(\mathbf{k},\omega)$ at each point in space and time. In a discrete system, decreasing $\Delta t$, $\Delta x$ or $\Delta y$ increases the number of frequency components present in the Fourier transform. However, if $\sigma$ is not adjusted accordingly, the effect will be a decrease in magnitude of each frequency component, changing the normalization of the power spectrum. 

Typically we are interested in preserving the value of $|\phi_n(\mathbf{k},\omega)|^2$, so that the normalization of the power spectrum is invariant when the numerical resolution is changed. From Parseval's theorem, we find that the sum of the discrete Fourier components must equal the expectation value of the original function in the time domain, which is $\sigma^{2}$ for white noise from the Wiener-Khinchin theorem. We therefore obtain 
\begin{align}
\label{eqn:parseval}
\sigma^{2}&=\sum_{M,N,P}|\phi_n(\mathbf{k},f)|^2\Delta f\Delta k_{x}\Delta k_{y}\\
&=\frac{4\pi^{2}|\phi_n(\mathbf{k},f)|^2}{\Delta T\Delta x\Delta y}
\end{align}
where
\begin{align}
\Delta k_x=\frac{2\pi}{L_{x}}=\frac{2\pi}{M\Delta x}
\end{align}
and there are $M$, $N$, and $P$ grid points in each dimension $x$, $y$ and $t$, respectively. In our model formulation, the analytic power spectrum is single-sided (positive frequencies only) and depends on $|\phi_n(\mathbf{k},\omega)|^2$. This quantity is equal to $\pi |\phi_n(\mathbf{k},f)|^2$  noting that Eq.~\eqref{eqn:parseval} refers to both positive and negative frequencies. Thus we finally have the result
\begin{align}
\sigma=\sqrt{\frac{4\pi^{3}|\phi_n(\mathbf{k},\omega)|^2}{\Delta T\Delta x\Delta y}}
\end{align}
which relates the standard deviation of the Gaussian distribution used to generate the noise in the time domain, to the power spectral density of the noise in the frequency domain. This enables the power spectral density to be correctly matched between the analytic spectrum and NeuroField, as shown in Fig.~\ref{fig:spindle_comparison}. 

For ease of use, users can specify the desired power spectral density of the white noise stimulus in the configuration file, as well as the physical dimensions of each population. NeuroField will then automatically calculate the appropriate Gaussian distribution to correctly match the desired power spectral density. 


\subsection{Performance}

\begin{itemize}
\item Some numbers about the runtime and memory requirements of NeuroField (FELIX)
\item Note that the memory requirements scale with the grid size, and the grid size depends on Lx and the propagator lengths (automatically enforced) (FELIX)
\item Also that the delays in the system cause O(n) increases in memory usage (FELIX)
\end{itemize}

\begin{table*}[!t]
\begin{center}
\begin{tabular}{l c c c }
\toprule
{\bf Platform}    & {\bf Processor}                   & {\bf Clock speed}       & {\bf Runtime} \\
\midrule
Windows	& i5-2500k & 4.8\,GHz & 14.3\,s \\
Arch Linux & i5-760 & 2.8\,GHz& 12.0\,s \\
RHEL6 & Xeon E5-2698 & 2.3\,GHz & 10\,s \\
Mac OS 10.10 & i5-4260U & 1.4\,GHz & 11.4\.s \\
\bottomrule
\end{tabular} 
\caption{Example NeuroField run times for a typical NeuroField run. The configuration file corresponds to the corticothalamic model, simulating 15 seconds sampled at 10000\,Hz with 144 grid points and outputting $\phi_e$ at 200\,Hz for all nodes. NeuroField was compiled natively on each platform using GCC 4.8 or higher with all applicable performance flags selected, with the exception of Windows where the MinGW was used for cross-compiling. TODO: Double check with John Palmer how to interpret these - to me these seem like they are memory-bound rather than CPU bound. Tests were run using eirs\_eyes\_closed.conf from the repository}
\label{table:params} 
\end{center} 
\end{table*}


\todo[inline]{Additional considerations?}

\section{Acknowledgements}
\label{sec:acknowledgements}
This work was supported by the Australian Research Council, National Health and Medical Research Council (through the Center for Integrated Research and Understanding of Sleep), and the Westmead Millennium Institute.

\section{References}
\bibliographystyle{complex_vancouver}
\bibliography{neurofield}

\end{document}
